import { Response } from 'express';
import { Contacto } from '../models/Contacto';
import { JerarquiaUsuarios } from '../models/JerarquiaUsuarios'; // RESTAURADO
import { RolUsuario } from '../models/Usuario';
import { Colegio } from '../models/Colegio';
import { AuthRequest } from '../types';
import { AuditLog, AccionAudit, EntidadAudit } from '../models/AuditLog';
import { Permiso } from '../models/Permiso';
import { UsuarioPermiso } from '../models/UsuarioPermiso';


export class ContactosController {
  // GET /contactos
  static async getContactos(req: AuthRequest, res: Response) {
    try {
      const {
        nombreColegio,
        q,
        page = 1,
        limit = 999999,
        sortBy = 'fechaAlta',
        sortOrder = 'desc'
      } = req.query;

      const pageNum = parseInt(page as string);
      const limitNum = parseInt(limit as string);
      const skip = (pageNum - 1) * limitNum;

      // Construir filtros
      const filtros: any = {};
      
      if (nombreColegio) filtros.nombreColegio = { $regex: nombreColegio, $options: 'i' };
      
      if (q) {
        filtros.$or = [
          { nombreCompleto: { $regex: q, $options: 'i' } },
          { telefono: { $regex: q, $options: 'i' } },
          { instagram: { $regex: q, $options: 'i' } },
          { nombreColegio: { $regex: q, $options: 'i' } }
        ];
      }

      // Aplicar visibilidad seg√∫n rol
      if (req.user!.rol !== RolUsuario.ADMIN) {
        const contactosVisibles = await ContactosController.getContactosVisibles(req.user!.userId, req.user!.rol);
        if (contactosVisibles.length > 0) {
          filtros._id = { $in: contactosVisibles };
        } else {
          // Si no hay contactos visibles para un comercial, no mostrar nada
          filtros._id = { $in: [] };
        }
      }
      // Para administradores, no aplicar ning√∫n filtro de visibilidad

      // Construir ordenamiento
      const sort: any = {};
      sort[sortBy as string] = sortOrder === 'asc' ? 1 : -1;

      // Ejecutar consulta
      const [contactos, total] = await Promise.all([
        Contacto.find(filtros)
          .populate('comercialId', 'nombre email')
          .sort(sort)
          .skip(skip)
          .limit(limitNum),
        Contacto.countDocuments(filtros)
      ]);

      res.json({
        success: true,
        data: contactos,
        pagination: {
          page: pageNum,
          limit: limitNum,
          total,
          pages: Math.ceil(total / limitNum)
        }
      });
    } catch (error) {
      console.error('Error obteniendo contactos:', error);
      res.status(500).json({
        success: false,
        message: 'Error interno del servidor'
      });
    }
  }

  // GET /contactos/todos - Obtener todos los contactos sin filtros
  static async getTodosLosContactos(req: AuthRequest, res: Response) {
    try {
      // La verificaci√≥n de permisos se hace en el middleware requireAnyPermission(['VER_CONTACTOS'])
      // Los administradores autom√°ticamente tienen todos los permisos

      console.log('üìä getTodosLosContactos - Obteniendo todos los contactos para admin:', req.user!.userId);

      // Obtener todos los contactos sin filtros
      const contactos = await Contacto.find({})
        .populate('comercialId', 'nombre email')
        .populate('createdBy', 'nombre email')
        .sort({ fechaAlta: -1 }); // Ordenar por fecha de alta descendente

      console.log(`üìä getTodosLosContactos - Total contactos encontrados: ${contactos.length}`);

      res.json({
        success: true,
        data: contactos,
        total: contactos.length,
        message: `Se encontraron ${contactos.length} contactos en total`
      });
    } catch (error) {
      console.error('Error obteniendo todos los contactos:', error);
      res.status(500).json({
        success: false,
        message: 'Error interno del servidor'
      });
    }
  }

  // GET /contactos/:id
  static async getContacto(req: AuthRequest, res: Response) {
    try {
      const { id } = req.params;
      
      const contacto = await Contacto.findById(id)
        .populate('comercialId', 'nombre email')
        .populate('createdBy', 'nombre email');

      if (!contacto) {
        return res.status(404).json({
          success: false,
          message: 'Contacto no encontrado'
        });
      }

      // Verificar visibilidad
      const tieneAcceso = await ContactosController.tieneAccesoContacto(req.user!.userId, req.user!.rol, contacto._id);
      if (!tieneAcceso) {
        return res.status(403).json({
          success: false,
          message: 'No tienes permisos para ver este contacto'
        });
      }

      res.json({
        success: true,
        data: contacto
      });
    } catch (error) {
      console.error('Error obteniendo contacto:', error);
      res.status(500).json({
        success: false,
        message: 'Error interno del servidor'
      });
    }
  }

  // POST /contactos
  static async crearContacto(req: AuthRequest, res: Response) {
    try {
      // Resolver conflicto en la extracci√≥n de campos
      const {
        nombreCompleto,
        telefono,
        instagram,
        nombreColegio,
        anioNacimiento,
        comercialId,
        diaLibre, // ‚Üê Mantener este campo
        universidadId,
        titulacionId,
        curso
      } = req.body;

      // Tel√©fono e Instagram son opcionales

      const nuevoContacto = new Contacto({
        nombreCompleto,
        telefono,
        instagram,
        nombreColegio,
        anioNacimiento,
        comercialId: comercialId || req.user!.userId,
        createdBy: req.user!.userId,
        diaLibre, // ‚Üê Mantener este campo
        ...(universidadId && { universidadId }),
        ...(titulacionId && { titulacionId }),
        ...(curso && { curso })
      });

      await nuevoContacto.save();
      
      // Registrar en auditor√≠a
      await AuditLog.create({
        usuarioId: req.user!.userId,
        entidad: EntidadAudit.CONTACTO,
        entidadId: nuevoContacto._id,
        accion: AccionAudit.CREATE,
        despues: nuevoContacto.toObject(),
        ip: req.ip,
        userAgent: req.get('User-Agent')
      });

      const contactoCompleto = await Contacto.findById(nuevoContacto._id)
        .populate('comercialId', 'nombre email');

      res.status(201).json({
        success: true,
        data: contactoCompleto,
        message: 'Contacto creado exitosamente'
      });
    } catch (error) {
      console.error('Error creando contacto:', error);
      res.status(500).json({
        success: false,
        message: 'Error interno del servidor'
      });
    }
  }

  // PUT /contactos/:id
  static async actualizarContacto(req: AuthRequest, res: Response) {
    try {
      const { id } = req.params;
      const datosActualizacion = req.body;

      const contactoAnterior = await Contacto.findById(id);
      if (!contactoAnterior) {
        return res.status(404).json({
          success: false,
          message: 'Contacto no encontrado'
        });
      }

      // Verificar acceso
      const tieneAcceso = await ContactosController.tieneAccesoContacto(req.user!.userId, req.user!.rol, id);
      if (!tieneAcceso) {
        return res.status(403).json({
          success: false,
          message: 'No tienes permisos para editar este contacto'
        });
      }

      const contactoActualizado = await Contacto.findByIdAndUpdate(
        id,
        { ...datosActualizacion, fechaModificacion: new Date() },
        { new: true, runValidators: true }
      ).populate('comercialId', 'nombre email');

      // Registrar en auditor√≠a
      await AuditLog.create({
        usuarioId: req.user!.userId,
        entidad: EntidadAudit.CONTACTO,
        entidadId: id,
        accion: AccionAudit.UPDATE,
        antes: contactoAnterior.toObject(),
        despues: contactoActualizado!.toObject(),
        ip: req.ip,
        userAgent: req.get('User-Agent')
      });

      res.json({
        success: true,
        data: contactoActualizado,
        message: 'Contacto actualizado exitosamente'
      });
    } catch (error) {
      console.error('Error actualizando contacto:', error);
      res.status(500).json({
        success: false,
        message: 'Error interno del servidor'
      });
    }
  }

  // DELETE /contactos/:id
  static async eliminarContacto(req: AuthRequest, res: Response) {
    try {
      const { id } = req.params;

      const contacto = await Contacto.findById(id);
      if (!contacto) {
        return res.status(404).json({
          success: false,
          message: 'Contacto no encontrado'
        });
      }

      // Verificar permisos (requiere permiso espec√≠fico o ser admin)
      const tienePermiso = req.user!.rol === RolUsuario.ADMIN || 
                          await ContactosController.tienePermisoEliminar(req.user!.userId);
      
      if (!tienePermiso) {
        return res.status(403).json({
          success: false,
          message: 'No tienes permisos para eliminar contactos'
        });
      }

      await Contacto.findByIdAndDelete(id);

      // Registrar en auditor√≠a
      await AuditLog.create({
        usuarioId: req.user!.userId,
        entidad: EntidadAudit.CONTACTO,
        entidadId: id,
        accion: AccionAudit.DELETE,
        antes: contacto.toObject(),
        ip: req.ip,
        userAgent: req.get('User-Agent')
      });

      res.json({
        success: true,
        message: 'Contacto eliminado exitosamente'
      });
    } catch (error) {
      console.error('Error eliminando contacto:', error);
      res.status(500).json({
        success: false,
        message: 'Error interno del servidor'
      });
    }
  }

  // PUT /contactos/:id/asignar-comercial
  static async asignarComercial(req: AuthRequest, res: Response) {
    try {
      const { id } = req.params;
      const { comercialId } = req.body;

      const contacto = await Contacto.findByIdAndUpdate(
        id,
        { comercialId, fechaModificacion: new Date() },
        { new: true }
      ).populate('comercialId', 'nombre email');

      if (!contacto) {
        return res.status(404).json({
          success: false,
          message: 'Contacto no encontrado'
        });
      }

      res.json({
        success: true,
        data: contacto,
        message: 'Comercial asignado exitosamente'
      });
    } catch (error) {
      console.error('Error asignando comercial:', error);
      res.status(500).json({
        success: false,
        message: 'Error interno del servidor'
      });
    }
  }

  // M√©todos auxiliares
  static async getContactosVisibles(usuarioId: string, rol: string): Promise<string[]> {
    console.log(`üîç getContactosVisibles llamada para usuario ${usuarioId} con rol ${rol}`);
    
    if (rol === RolUsuario.ADMIN) {
      console.log('üëë Usuario es ADMIN - sin filtros');
      return []; // Admin ve todos, no aplicar filtro
    }
  
  // Para comerciales, incluir sus subordinados
  const subordinados = await ContactosController.getSubordinados(usuarioId);
  const comercialesVisibles = [usuarioId, ...subordinados];
  
  console.log(`üë• Comerciales visibles para ${usuarioId}:`, comercialesVisibles);
    
  const contactos = await Contacto.find({
    $or: [
      { comercialId: { $in: comercialesVisibles } }, // Contactos asignados a √©l y sus subordinados
      { createdBy: usuarioId } // Contactos creados por √©l
    ]
  }).select('_id');
  
  console.log(`üìä Total contactos encontrados: ${contactos.length}`);
  
  return contactos.map(c => c._id.toString());
  }

  // Funci√≥n para obtener subordinados recursivamente
  static async getSubordinados(jefeId: string): Promise<string[]> {
    try {
      console.log(`üîç Buscando subordinados para jefe: ${jefeId}`);
      
      const subordinadosDirectos = await JerarquiaUsuarios.find({ jefeId }).select('subordinadoId');
      let todosLosSubordinados = subordinadosDirectos.map(s => s.subordinadoId.toString());
      
      console.log(`üë• Subordinados directos encontrados: ${todosLosSubordinados.length}`);
      
      // Recursivamente obtener subordinados de subordinados
      for (const subordinadoId of subordinadosDirectos.map(s => s.subordinadoId.toString())) {
        const subSubordinados = await ContactosController.getSubordinados(subordinadoId);
        todosLosSubordinados = [...todosLosSubordinados, ...subSubordinados];
      }
      
      const subordinadosUnicos = [...new Set(todosLosSubordinados)];
      console.log(`üìä Total subordinados (incluyendo sub-subordinados): ${subordinadosUnicos.length}`);
      
      return subordinadosUnicos;
    } catch (error) {
      console.error('‚ùå Error obteniendo subordinados:', error);
      return [];
    }
  }

  static async tieneAccesoContacto(usuarioId: string, rol: string, contactoId: string): Promise<boolean> {
    if (rol === RolUsuario.ADMIN) return true;
    
    const contactosVisibles = await ContactosController.getContactosVisibles(usuarioId, rol);
    return contactosVisibles.includes(contactoId);
  }

  static async tienePermisoEliminar(usuarioId: string): Promise<boolean> {
    try {
      // Buscar el permiso de eliminar contactos
      const permiso = await Permiso.findOne({ clave: 'ELIMINAR_CONTACTOS' });
      if (!permiso) {
        console.log('‚ùå Permiso ELIMINAR_CONTACTOS no encontrado en el sistema');
        return false;
      }
  
      // Verificar si el usuario tiene este permiso asignado
      const usuarioPermiso = await UsuarioPermiso.findOne({
        usuarioId: usuarioId,
        permisoId: permiso._id
      });
  
      return !!usuarioPermiso;
    } catch (error) {
      console.error('Error verificando permiso de eliminar:', error);
      return false;
    }
  }

  // POST /contactos/importar - Importar contactos desde JSON
  static async importarContactosJSON(req: AuthRequest, res: Response) {
    try {
      const { contactos } = req.body;
      
      // Log de depuraci√≥n para ver qu√© datos llegan al backend
      console.log('üì• POST /api/contactos/importar - Body:', JSON.stringify(req.body, null, 2));
      console.log('üìä N√∫mero de contactos recibidos:', contactos?.length || 0);
      
      if (contactos && Array.isArray(contactos)) {
        contactos.forEach((contacto, index) => {
          console.log(`üìã Contacto ${index + 1}:`, {
            nombreCompleto: contacto.nombreCompleto,
            telefono: contacto.telefono,
            nombreColegio: contacto.nombreColegio,
            comercialId: contacto.comercialId
          });
        });
      }

      if (!contactos || !Array.isArray(contactos)) {
        return res.status(400).json({
          success: false,
          message: 'Se requiere un array de contactos en el campo "contactos"'
        });
      }

      const resultados = {
        exitosos: 0,
        errores: 0,
        detalles: [] as Array<{ fila: number; error?: string; contacto?: any }>
      };

      let filaActual = 0;

      // Procesar cada contacto
      for (const data of contactos) {
        filaActual++;
        
        try {
          // Validar datos requeridos
          const erroresValidacion = [];
          
          if (!data.nombreCompleto?.trim()) {
            erroresValidacion.push('Nombre completo es requerido');
          }
          
          // Tel√©fono e Instagram son opcionales
          
          if (!data.nombreColegio?.trim()) {
            erroresValidacion.push('Nombre del colegio es requerido');
          }
          
          if (!data.anioNacimiento) {
            erroresValidacion.push('A√±o de nacimiento es requerido');
          }

          if (erroresValidacion.length > 0) {
            resultados.errores++;
            resultados.detalles.push({
              fila: filaActual,
              error: erroresValidacion.join(', ')
            });
            continue;
          }

          // Preparar datos del contacto
          const nuevoContacto = new Contacto({
            nombreCompleto: data.nombreCompleto.trim(),
            telefono: data.telefono?.trim() || null,
            instagram: data.instagram?.trim() || null,
            nombreColegio: data.nombreColegio.trim(),
            anioNacimiento: parseInt(data.anioNacimiento),
            comercialId: data.comercialId?.trim() || req.user!.userId,
            createdBy: req.user!.userId
          });

          await nuevoContacto.save();
          
          // Registrar en auditor√≠a
          await AuditLog.create({
            usuarioId: req.user!.userId,
            entidad: EntidadAudit.CONTACTO,
            entidadId: nuevoContacto._id,
            accion: AccionAudit.CREATE,
            despues: nuevoContacto.toObject(),
            ip: req.ip,
            userAgent: req.get('User-Agent')
          });

          resultados.exitosos++;
          resultados.detalles.push({
            fila: filaActual,
            contacto: {
              id: nuevoContacto._id,
              nombre: nuevoContacto.nombreCompleto
            }
          });
        } catch (error: any) {
          resultados.errores++;
          resultados.detalles.push({
            fila: filaActual,
            error: error.message || 'Error desconocido al crear contacto'
          });
        }
      }

      res.json({
        success: true,
        message: `Importaci√≥n completada: ${resultados.exitosos} contactos creados, ${resultados.errores} errores`,
        data: {
          contactosCreados: resultados.exitosos,
          errores: resultados.errores,
          detalles: resultados.detalles
        }
      });
    } catch (error) {
      console.error('Error importando contactos desde JSON:', error);
      res.status(500).json({
        success: false,
        message: 'Error interno del servidor durante la importaci√≥n'
      });
    }
  }

  // GET /contactos/comercial/:comercialId - Obtener contactos de un comercial y sus subordinados
  static async getContactosComercial(req: AuthRequest, res: Response) {
    try {
      const { comercialId } = req.params;
      const {
        nombreColegio,
        q,
        page = 1,
        limit = 999999,
        sortBy = 'fechaAlta',
        sortOrder = 'desc'
      } = req.query;

      const pageNum = parseInt(page as string);
      const limitNum = parseInt(limit as string);
      const skip = (pageNum - 1) * limitNum;

      // Verificar permisos - solo admin o el mismo comercial puede ver sus contactos
      if (req.user!.rol !== RolUsuario.ADMIN && req.user!.userId !== comercialId) {
        return res.status(403).json({
          success: false,
          message: 'No tienes permisos para ver los contactos de este comercial'
        });
      }

      // Obtener todos los subordinados del comercial
      const subordinados = await ContactosController.getSubordinados(comercialId);
      const comercialesIncluidos = [comercialId, ...subordinados];
      
      console.log(`üìä Obteniendo contactos para comercial ${comercialId} y subordinados:`, comercialesIncluidos);

      // Construir filtros base
      const filtros: any = {
        $or: [
          { comercialId: { $in: comercialesIncluidos } }, // Contactos asignados al comercial y sus subordinados
          { createdBy: comercialId } // Contactos creados por el comercial
        ]
      };
      
      // Aplicar filtros adicionales
      if (nombreColegio) filtros.nombreColegio = { $regex: nombreColegio, $options: 'i' };
      
      if (q) {
        filtros.$and = [
          { $or: filtros.$or }, // Mantener el filtro de comerciales
          {
            $or: [
              { nombreCompleto: { $regex: q, $options: 'i' } },
              { telefono: { $regex: q, $options: 'i' } },
              { instagram: { $regex: q, $options: 'i' } },
              { nombreColegio: { $regex: q, $options: 'i' } }
            ]
          }
        ];
        delete filtros.$or; // Remover el $or original ya que ahora est√° en $and
      }

      // Construir ordenamiento
      const sort: any = {};
      sort[sortBy as string] = sortOrder === 'asc' ? 1 : -1;

      // Ejecutar consulta
      const [contactos, total] = await Promise.all([
        Contacto.find(filtros)
          .populate('comercialId', 'nombre email')
          .sort(sort)
          .skip(skip)
          .limit(limitNum),
        Contacto.countDocuments(filtros)
      ]);

      res.json({
        success: true,
        data: contactos,
        pagination: {
          page: pageNum,
          limit: limitNum,
          total,
          pages: Math.ceil(total / limitNum)
        },
        metadata: {
          comercialId,
          subordinados,
          comercialesIncluidos
        }
      });
    } catch (error) {
      console.error('Error obteniendo contactos del comercial:', error);
      res.status(500).json({
        success: false,
        message: 'Error interno del servidor'
      });
    }
  }

  // GET /contactos/colegios - Obtener todos los colegios √∫nicos
  static async getColegios(req: AuthRequest, res: Response) {
    try {
      // Importar el modelo Universidad
      const { Universidad } = await import('../models/Universidad');
      
      // Obtener colegios desde la tabla de universidades (donde ahora est√°n los colegios)
      const colegios = await Universidad.find({ activa: true })
        .select('nombre')
        .sort({ nombre: 1 });
      
      const colegiosLista = colegios.map(colegio => colegio.nombre);
      
      console.log('üîç Colegios encontrados en tabla universidades:', colegiosLista.length);
      
      res.json({
        success: true,
        data: {
          colegios: colegiosLista
        }
      });
    } catch (error) {
      console.error('Error getting colegios:', error);
      res.status(500).json({
        success: false,
        message: 'Error interno del servidor'
      });
    }
  }

}